# Better Morning Alarm — Implementation Guide

## 1. Folder Structure

```
Morning focus/
├── android/                          # Generated by: npx cap add android
│   └── app/src/main/
│       ├── AndroidManifest.xml       # Merge snippets from docs/android/
│       ├── java/.../MainActivity.java
│       └── res/
│           ├── values/strings.xml
│           └── raw/                 # Custom alarm sound (e.g. alarm_sound.mp3)
├── public/
│   ├── sounds/
│   │   └── alarm.mp3                 # Fallback / web alarm sound
│   ├── icon-192.png
│   └── icon-512.png
├── src/
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx                  # Router: render screen by alarm state
│   │   ├── globals.css
│   │   └── (auth)/login/...
│   ├── components/
│   │   ├── ui/                       # Shadcn UI (optional)
│   │   ├── alarm/
│   │   │   ├── NightModeScreen.tsx   # State: IDLE — next alarm time
│   │   │   ├── WakeUpScreen.tsx      # State: RINGING — slide to begin
│   │   │   └── ProtocolScreen.tsx   # State: PROTOCOL — manifesto + "I AM READY"
│   │   ├── AlarmSetting.tsx          # Existing alarm time + days
│   │   ├── Header.tsx
│   │   └── ...
│   ├── store/
│   │   └── useAlarmStore.ts          # Zustand: IDLE | RINGING | PROTOCOL | FOCUSED
│   ├── lib/
│   │   ├── constants.ts
│   │   ├── notifications.ts          # Capacitor Local Notifications + channel config
│   │   └── ...
│   ├── hooks/
│   │   ├── useAlarmTrigger.ts        # Schedule/cancel alarm, handle notification open
│   │   └── useDailyReset.ts
│   ├── context/
│   └── locales/
├── docs/
│   └── android/
│       └── AndroidManifest.snippets.xml
├── capacitor.config.ts
├── package.json
└── next.config.ts
```

---

## 2. Project Setup (Recap)

### 2.1 Next.js + Tailwind

Already in place. Ensure Tailwind and PostCSS are configured.

### 2.2 Install Dependencies

```bash
npm install zustand @capacitor/core @capacitor/android @capacitor/local-notifications @capacitor-community/keep-awake
npx cap add android
```

(Optional, for `cap sync` / `cap open`: `npm install -D @capacitor/cli` or use `npx cap`.)

### 2.3 Capacitor Android Setup

```bash
# Build the Next.js app (output: out/ or .next/ depending on static export)
npm run build

# Add Capacitor (if not already)
npx cap add android

# Point Capacitor to the built web assets (see capacitor.config.ts)
npx cap sync android

# Open in Android Studio
npx cap open android
```

**Important:** For Next.js + Capacitor, use a static export so the app can be served from the native WebView. In `next.config.js` add:

```js
const nextConfig = {
  output: "export",
  // ... rest
};
```

Then `next build` produces static files in `out/`. The `capacitor.config.ts` in this project already sets `webDir: "out"`.

### 2.4 Android Studio

- Open `android/` folder.
- Merge the permissions and `<application>` snippets from `docs/android/AndroidManifest.snippets.xml` into `android/app/src/main/AndroidManifest.xml`.
- Add a custom alarm sound under `android/app/src/main/res/raw/alarm_sound.mp3` (lowercase, no spaces).
- Build and run on device or emulator.

---

## 3. State Management (Zustand)

See **`src/store/useAlarmStore.ts`** for the full implementation.

- **States:** `IDLE` | `RINGING` | `PROTOCOL` | `FOCUSED`
- **Data:** `wakeUpTime` (e.g. `"07:00"`), `alarmDays` (0–6), `personalManifesto` (string)
- **Actions:** `setWakeUpTime`, `setAlarmDays`, `setPersonalManifesto`, `setState`, `dismissToProtocol`, `finishProtocol`

---

## 4. Android Native Logic (Critical)

### 4.1 Local Notifications Channel

- **Channel ID:** `morning_focus_alarm`
- **Importance:** `5` (max / urgent) so the alarm can wake the device and show full-screen intent.
- **Visibility:** `1` (Public) so it appears on lock screen.
- **Sound:** Custom sound from `res/raw/alarm_sound.mp3`; enable vibration.

Implementation is in **`src/lib/notifications.ts`** (request permissions, create channel, schedule/cancel).

### 4.2 Full-Screen Intent & Doze

- Use `USE_FULL_SCREEN_INTENT` and schedule with `LocalNotifications.schedule()` so the system can show the full-screen intent when the notification fires.
- For more reliable firing in Doze, consider **`@capacitor-community/background-runner`** or **exact alarms** with `SCHEDULE_EXACT_ALARM` so the OS treats the app as an alarm app and relaxes Doze for the scheduled time.

### 4.3 AndroidManifest.xml

Use the snippets in **`docs/android/AndroidManifest.snippets.xml`** and merge them into your generated `android/app/src/main/AndroidManifest.xml`.

---

## 5. UI/UX Architecture

| State     | Screen           | Description |
|----------|------------------|-------------|
| **IDLE** | Night Mode       | Black background, next alarm time only. |
| **RINGING** | Wake Up       | Full-screen overlay, gradient animation, “Slide to Begin” gesture (no simple button). |
| **PROTOCOL** | Protocol     | Personal manifesto text, high contrast; “I AM READY” button at bottom. |
| **FOCUSED** | Main app      | Normal app (e.g. home with protocol, quote, one thing). |

Flow: **IDLE → (alarm fires) → RINGING → (slide to begin) → PROTOCOL → (I AM READY) → FOCUSED.**

---

## 6. Next Steps

1. Implement **NightModeScreen**, **WakeUpScreen** (with slide gesture), and **ProtocolScreen**.
2. In **page.tsx**, branch on `useAlarmStore.getState().state` and render the correct screen.
3. In **useAlarmTrigger**, schedule the next alarm from `wakeUpTime` + `alarmDays`, and on notification action open the app and call `setState('RINGING')` (and acquire keep-awake if needed).
4. Add Shadcn UI if desired (`npx shadcn@latest init` and add components).
